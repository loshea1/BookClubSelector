<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bookies Availability (Firebase)</title>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

   <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 2em;
      text-align: center;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #2c5f2d;
      font-weight: bold;
    }
    nav a:hover {
      text-decoration: underline;
    }
    #availabilityContainer {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }
    #gridWrapper, #summaryWrapper {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1em;
      flex: 1 1 45%;
      max-width: 48%;
      box-sizing: border-box;
    }
    table {
      border-collapse: collapse;
      margin: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      min-width: 40px;
      text-align: center;
    }
    td.available { background-color: #a8e6a1; }
    .submit-area {
      margin-bottom: 1em;
    }
    select, input[type="text"], button {
      padding: 10px;
      margin: 5px;
    }
    #countdownTimer {
      font-weight: bold;
      color: #b22222;
      margin-bottom: 1em;
    }

     table, td, th {
  -webkit-user-select: none;  /* Chrome/Safari */
  -moz-user-select: none;     /* Firefox */
  -ms-user-select: none;      /* IE10+ */
  user-select: none;          /* Standard */
}

  </style>
</head>
<body>

<nav style="margin-bottom: 2em;">
  <a href="index.html">üè† Submit</a> |
  <a href="history.html">üìö History</a> |
  <a href="availability.html">üìÜ Availability</a> |
  <a href="admin.html">üõ†Ô∏è Admin</a>
</nav>

  <p id="countdownTimer"></p>

 <h1>Next Bookies Meeting Availability</h1>
  <div class="submit-area">
    <select id="userSelect" required></select>
      <option value="" disabled selected>Select your name</option>
      <option value="__new">+ New User</option>
    </select>
    <input type="text" id="newUserInput" placeholder="Enter new name" style="display:none;" />
    <button id="submitButton" disabled>Submit</button>
  </div>

  <div id="availabilityContainer">
    <div id="gridWrapper">
      <h3>Your Selection</h3>
      <div id="grid"></div>
    </div>
    <div id="summaryWrapper">
      <h3>Summary</h3>
      <div id="summary"></div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = {
    apiKey: "AIzaSyDlQQOiioFMEsvvJfduLXlDqMN1T5s8cWo",
    authDomain: "bookies-availability.firebaseapp.com",
    databaseURL: "https://bookies-availability-default-rtdb.firebaseio.com",
    projectId: "bookies-availability",
    storageBucket: "bookies-availability.appspot.com",
    messagingSenderId: "429713911832",
    appId: "1:429713911832:web:0da21ca51099bfd8e7536d"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Populate dropdown with existing users

db.ref('responses').once('value').then(snapshot => {
  const data = snapshot.val() || {};
  const names = Object.keys(data);
  usernameSelect.innerHTML = '<option value="">-- Select your name --</option>';
  names.forEach(name => {
    const option = document.createElement('option');
    option.value = name;
    option.textContent = name;
    usernameSelect.appendChild(option);
  });

  const customOption = document.createElement('option');
  customOption.value = '__new__';
  customOption.textContent = 'Enter new name...';
  usernameSelect.appendChild(customOption);
});

// Handle name selection
usernameSelect.addEventListener('change', () => {
  if (usernameSelect.value === '__new__') {
    newNameInput.style.display = 'inline-block';
    newNameInput.focus();
  } else {
    newNameInput.style.display = 'none';
    loadUserAvailability(usernameSelect.value); // Load existing availability
  }
});


  const startDate = new Date();
  startDate.setMonth(startDate.getMonth() + 3);
  startDate.setDate(1);
  const cutoffDate = new Date(startDate);
  cutoffDate.setDate(cutoffDate.getDate() + 7);
  cutoffDate.setHours(23, 59, 59, 999);
  const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0);
  const hours = [17, 18, 19, 20, 21, 22];

  let availability = {}; // Current user availability state
  const cellMap = {};

  let isMouseDown = false;
  let toggleState = null;

  const userSelect = document.getElementById('userSelect');
  const submitBtn = document.getElementById('submitButton');

  function formatDate(d) {
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  }

  function generateGrid() {
    const gridDiv = document.getElementById('grid');
    gridDiv.innerHTML = '';
    const table = document.createElement('table');

    // Header row with hours
    const header = document.createElement('tr');
    header.innerHTML = '<th>Date</th>' + hours.map(h => `<th>${h}:00</th>`).join('');
    table.appendChild(header);

    // Create rows for each date
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const row = document.createElement('tr');
      const displayDate = formatDate(new Date(d)); // new Date to avoid mutation issues
      const isoDate = d.toISOString().split('T')[0];
      row.innerHTML = `<td>${displayDate}</td>`;

      hours.forEach(hour => {
        const key = `${isoDate}_${hour}`;
        availability[key] = availability[key] || false;

        const td = document.createElement('td');
        td.className = availability[key] ? 'available' : '';

        td.onmousedown = () => {
          isMouseDown = true;
          toggleState = !availability[key];
          availability[key] = toggleState;
          td.className = toggleState ? 'available' : '';
        };

        td.onmouseover = () => {
          if (isMouseDown) {
            availability[key] = toggleState;
            td.className = toggleState ? 'available' : '';
          }
        };

        td.onmouseup = () => {
          isMouseDown = false;
        };

        row.appendChild(td);
        cellMap[key] = td;
      });

      table.appendChild(row);
    }

    document.onmouseup = () => { isMouseDown = false; };
    gridDiv.appendChild(table);
  }

  // Load all users who submitted availability and populate dropdown
  function loadUsers() {
    db.ref('responses').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      const users = Object.keys(data).sort();

      // Clear and add default option
      //userSelect.innerHTML = '<option value="" disabled selected>Select your name</option>';

      //users.forEach(user => {
        const option = document.createElement('option');
        option.value = user;
        option.textContent = user;
        userSelect.appendChild(option);
      //});

      // Enable submit button only if user selected
      userSelect.disabled = users.length === 0;
      submitBtn.disabled = true;
    });
  }

  // Load availability for selected user and update grid
  function loadUserAvailability(user) {
    if (!user) return;

    db.ref('responses/' + user).once('value').then(snapshot => {
      const data = snapshot.val() || {};
      availability = {}; // reset local availability

      // Update availability state from DB
      for (const key in data) {
        availability[key] = !!data[key];
      }

      // Update grid cells visually
      for (const key in cellMap) {
        if (availability[key]) {
          cellMap[key].classList.add('available');
        } else {
          cellMap[key].classList.remove('available');
        }
      }

      submitBtn.disabled = false;
    });
  }

  // Submit current availability for selected user
function submitAvailability() {
  let selected = userSelect.value;

  if (!selected) {
    alert('Please select your name');
    return;
  }

  let name = selected;

  if (selected === '__new') {
    name = document.getElementById('newUserInput').value.trim();
    if (!name) {
      alert('Please enter your name');
      return;
    }
  }

  if (new Date() > cutoffDate) {
    alert('Sorry, submissions are now closed.');
    return;
  }

  db.ref('responses/' + name).set(availability).then(() => {
    alert('Availability submitted!');
    document.getElementById('newUserInput').style.display = 'none';
    document.getElementById('newUserInput').value = '';
    loadUsers();
    loadSummary();
    userSelect.value = name;  // Set the dropdown to the new user

    const newOption = document.createElement('option');
newOption.value = name;
newOption.textContent = name;
userSelect.appendChild(newOption);
userSelect.value = name;

  });
}


  // Load summary of all availability
  function loadSummary() {
    db.ref('responses').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      const counts = {};
      const whoSelected = {};
      const userCount = Object.keys(data).length;

      for (const user in data) {
        const userAvail = data[user];
        for (const key in userAvail) {
          if (userAvail[key]) {
            counts[key] = (counts[key] || 0) + 1;
            if (!whoSelected[key]) whoSelected[key] = [];
            whoSelected[key].push(user);
          }
        }
      }

      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = '';
      if(userCount === 0) {
        summaryDiv.textContent = 'No availability submissions yet.';
        return;
      }

      const table = document.createElement('table');
      const header = document.createElement('tr');
      header.innerHTML = '<th>Date</th>' + hours.map(h => `<th>${h}:00</th>`).join('');
      table.appendChild(header);

      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const row = document.createElement('tr');
        const displayDate = formatDate(new Date(d));
        const isoDate = d.toISOString().split('T')[0];
        row.innerHTML = `<td>${displayDate}</td>`;

        hours.forEach(hour => {
          const key = `${isoDate}_${hour}`;
          const count = counts[key] || 0;
          const greenIntensity = Math.floor((count / userCount) * 200);
          const color = `rgb(${255 - greenIntensity}, 255, ${255 - greenIntensity})`;
          const td = document.createElement('td');
          td.style.backgroundColor = count ? color : '#fff';
          td.textContent = count > 0 ? count : '';
          if (whoSelected[key]) {
            td.title = whoSelected[key].join(', ');
          }
          row.appendChild(td);
        });

        table.appendChild(row);
      }

      highlightTopTimes(counts);
      summaryDiv.appendChild(table);
    });
  }

  function highlightTopTimes(counts) {
    const entries = Object.entries(counts);
    const sorted = entries.sort((a, b) => b[1] - a[1]).slice(0, 3);
    const topKeys = new Set(sorted.map(e => e[0]));

    const summaryRows = document.querySelectorAll('#summary table tr');

    for (const row of summaryRows) {
      const cells = row.querySelectorAll('td');
      if (cells.length < 2) continue;
      const dateText = cells[0].textContent;
      const date = new Date(dateText + ", " + new Date().getFullYear());
      const isoDate = date.toISOString().split('T')[0];

      for (let i = 1; i < cells.length; i++) {
        const hour = hours[i - 1];
        const key = `${isoDate}_${hour}`;
        if (topKeys.has(key)) {
          cells[i].style.border = '3px solid #2c5f2d';
        }
      }
    }
  }

  // Event listeners
  userSelect.addEventListener('change', () => {
      const val = userSelect.value;
  if (val === '__new') {
    document.getElementById('newUserInput').style.display = 'inline-block';
    submitBtn.disabled = false;
  } else {
    document.getElementById('newUserInput').style.display = 'none';
    loadUserAvailability(val);
  }
  });

  submitBtn.addEventListener('click', submitAvailability);

  generateGrid();
  loadUsers();
  loadSummary();
});
</script>
</body>
</html>
