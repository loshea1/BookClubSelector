<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bookies Availability (Firebase)</title>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      padding: 2em;
      text-align: center;
    }
    nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #2c5f2d;
      font-weight: bold;
    }
    nav a:hover { text-decoration: underline; }
    #availabilityContainer {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
    }
    #gridWrapper, #summaryWrapper {
      background: #fff;
      border: 1px solid #ccc;
      padding: 1em;
      flex: 1 1 45%;
      max-width: 48%;
      box-sizing: border-box;
    }
    table {
      border-collapse: collapse;
      margin: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 5px;
      min-width: 40px;
      text-align: center;
    }
    td.available { background-color: #a8e6a1; }
    .submit-area { margin-bottom: 1em; }
    select, button {
      padding: 10px;
      margin: 5px;
    }
    #countdownTimer {
      font-weight: bold;
      color: #b22222;
      margin-bottom: 1em;
    }
    table, td, th {
      user-select: none;
    }
  </style>
</head>
<body>
  <nav style="margin-bottom: 2em;">
    <a href="index.html">üè† Submit</a> |
    <a href="history.html">üìö History</a> |
    <a href="availability.html">üìÜ Availability</a> |
    <a href="admin.html">üõ†Ô∏è Admin</a>
  </nav>

  <p id="countdownTimer"></p>
  <h1>Next Bookies Meeting Availability</h1>

  <div class="submit-area">
    <select id="userSelect" required>
      <option value="" disabled selected>Select your name</option>
    </select>
    <button id="submitButton" disabled>Submit</button>
  </div>

  <div id="availabilityContainer">
    <div id="gridWrapper">
      <h3>Your Selection</h3>
      <div id="grid"></div>
    </div>
    <div id="summaryWrapper">
      <h3>Summary</h3>
      <div id="summary"></div>
    </div>
  </div>

<script>
window.addEventListener('DOMContentLoaded', () => {
  const firebaseConfig = { /* Firebase config */ };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const hours = [17, 18, 19, 20, 21, 22];

  const countdownTimer = document.getElementById('countdownTimer');
  const userSelect = document.getElementById('userSelect');
  const submitBtn = document.getElementById('submitButton');

  let availability = {};
  const cellMap = {};
  let isMouseDown = false;
  let toggleState = null;
  let cutoffDate = null;
  let timerInterval = null;

  // Start the countdown timer to submission deadline
  function startCountdown() {
    if (!cutoffDate) return;
    function updateCountdown() {
      const now = new Date();
      const diff = cutoffDate - now;
      if (diff <= 0) {
        countdownTimer.textContent = "Submissions are now closed.";
        clearInterval(timerInterval);
        return;
      }
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hrs = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const mins = Math.floor((diff / (1000 * 60)) % 60);
      const secs = Math.floor((diff / 1000) % 60);
      countdownTimer.textContent = `Deadline in ${days}d ${hrs}h ${mins}m ${secs}s`;
    }
    timerInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
  }

  // Load availability deadline and compute start/end dates
  db.ref('settings/availabilityDeadline').once('value').then(snapshot => {
    const deadlineStr = snapshot.val();
    if (deadlineStr) {
      cutoffDate = new Date(deadlineStr);
      window.startDate = new Date(cutoffDate);
      window.startDate.setMonth(startDate.getMonth() + 3);
      window.endDate = new Date(startDate);
      window.endDate.setDate(endDate.getDate() + 30);

      startCountdown();
      generateGrid();
      loadSummary();
    } else {
      countdownTimer.textContent = "No deadline set by admin yet.";
    }
  });

  // Populate dropdown from Firebase members
  function populateDropdownFromFirebase() {
    db.ref('members').once('value').then(snapshot => {
      const members = snapshot.val() || [];
      userSelect.innerHTML = `
        <option value="" disabled selected>Select your name</option>
        ${Object.values(members).map(name => `<option value="${name}">${name}</option>`).join('')}
      `;
      const savedName = localStorage.getItem('bookiesUser');
      if (savedName && userSelect.querySelector(`option[value="${savedName}"]`)) {
        userSelect.value = savedName;
        loadUserAvailability(savedName);
      }
    });
  }

  function formatDate(d) {
    return d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  }

  // Create editable availability grid
  function generateGrid() {
    const gridDiv = document.getElementById('grid');
    gridDiv.innerHTML = '';
    const table = document.createElement('table');
    const header = document.createElement('tr');
    header.innerHTML = '<th>Date</th>' + hours.map(h => `<th>${h}:00</th>`).join('');
    table.appendChild(header);

    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const row = document.createElement('tr');
      const displayDate = formatDate(new Date(d));
      const isoDate = d.toISOString().split('T')[0];
      row.innerHTML = `<td>${displayDate}</td>`;
      hours.forEach(hour => {
        const key = `${isoDate}_${hour}`;
        availability[key] = availability[key] || false;
        const td = document.createElement('td');
        td.className = availability[key] ? 'available' : '';
        td.onmousedown = () => {
          isMouseDown = true;
          toggleState = !availability[key];
          availability[key] = toggleState;
          td.className = toggleState ? 'available' : '';
        };
        td.onmouseover = () => {
          if (isMouseDown) {
            availability[key] = toggleState;
            td.className = toggleState ? 'available' : '';
          }
        };
        td.onmouseup = () => { isMouseDown = false; };
        row.appendChild(td);
        cellMap[key] = td;
      });
      table.appendChild(row);
    }
    document.onmouseup = () => { isMouseDown = false; };
    gridDiv.appendChild(table);
  }

  // Load existing user availability
  function loadUserAvailability(user) {
    if (!user) return;
    db.ref('responses/' + user).once('value').then(snapshot => {
      const data = snapshot.val() || {};
      availability = {};
      for (const key in data) availability[key] = !!data[key];
      for (const key in cellMap) {
        cellMap[key].classList.toggle('available', availability[key]);
      }
      submitBtn.disabled = false;
    });
  }

  // Save submitted availability to Firebase
  function submitAvailability() {
    const selected = userSelect.value;
    if (!selected) return alert('Please select your name');
    if (new Date() > cutoffDate) return alert('Sorry, submissions are now closed.');
    db.ref('responses/' + selected).set(availability).then(() => {
      submitBtn.textContent = 'Re-submit';
      loadSummary();
    });
    localStorage.setItem('bookiesUser', selected);
  }

  // Load all users' availability and create heatmap summary
  function loadSummary() {
    db.ref('responses').once('value').then(snapshot => {
      const data = snapshot.val() || {};
      const counts = {}, whoSelected = {}, userCount = Object.keys(data).length;
      for (const user in data) {
        for (const key in data[user]) {
          if (data[user][key]) {
            counts[key] = (counts[key] || 0) + 1;
            (whoSelected[key] ||= []).push(user);
          }
        }
      }
      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = '';
      if (userCount === 0) return summaryDiv.textContent = 'No availability submissions yet.';
      const table = document.createElement('table');
      const header = document.createElement('tr');
      header.innerHTML = '<th>Date</th>' + hours.map(h => `<th>${h}:00</th>`).join('');
      table.appendChild(header);

      for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        const row = document.createElement('tr');
        const displayDate = formatDate(new Date(d));
        const isoDate = d.toISOString().split('T')[0];
        row.innerHTML = `<td>${displayDate}</td>`;
        hours.forEach(hour => {
          const key = `${isoDate}_${hour}`;
          const count = counts[key] || 0;
          const green = Math.floor((count / userCount) * 200);
          const td = document.createElement('td');
          td.style.backgroundColor = count ? `rgb(${255 - green}, 255, ${255 - green})` : '#fff';
          td.textContent = count || '';
          if (whoSelected[key]) td.title = whoSelected[key].join(', ');
          row.appendChild(td);
        });
        table.appendChild(row);
      }
      highlightTopTimes(counts);
      summaryDiv.appendChild(table);
    });
  }

  // Highlight top 3 most popular times
  function highlightTopTimes(counts) {
    const topKeys = new Set(Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 3).map(e => e[0]));
    const rows = document.querySelectorAll('#summary table tr');
    for (const row of rows) {
      const cells = row.querySelectorAll('td');
      if (cells.length < 2) continue;
      const dateText = cells[0].textContent;
      const date = new Date(dateText + ", " + new Date().getFullYear());
      const isoDate = date.toISOString().split('T')[0];
      for (let i = 1; i < cells.length; i++) {
        const hour = hours[i - 1];
        const key = `${isoDate}_${hour}`;
        if (topKeys.has(key)) cells[i].style.border = '3px solid #2c5f2d';
      }
    }
  }

  // Event bindings
  userSelect.addEventListener('change', () => {
    const val = userSelect.value;
    submitBtn.disabled = !val;
    availability = {};
    Object.keys(cellMap).forEach(k => cellMap[k].classList.remove('available'));
    if (val) loadUserAvailability(val);
  });

  submitBtn.addEventListener('click', submitAvailability);
  populateDropdownFromFirebase();
});
</script>
</body>
</html>
