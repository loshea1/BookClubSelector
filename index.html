<!DOCTYPE html>
<html lang="en">
<head>

  <script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Book Club Submission</title>
  <style>
    body { font-family: Arial; text-align: center; padding: 1em; }
    input, button { padding: 8px; margin: 8px; width: 200px; }
    #countdownTimer { font-weight: bold; color: #b22222; margin-top: 10px; }

      nav a {
  margin: 0 10px;
  text-decoration: none;
  color: #2c5f2d;
  font-weight: bold;
}
nav a:hover {
  text-decoration: underline;
}
  </style>
</head>
<body>

  <nav style="margin-bottom: 2em;">
  <a href="index.html">üè† Submit</a> |
  <a href="history.html">üìö History</a> |
  <a href="availability.html">üìÜ Availability</a> |
  <a href="admin.html">üõ†Ô∏è Admin</a>
</nav>
  
  <h1>üìñ Book Club Submission</h1>
  <p id="countdownTimer" style="font-weight: bold; color: #b22222;"></p>

  <div id="formSection">
    <input id="name" placeholder="Your Name"/><br/>
    <input id="title" placeholder="Book Title"/><br/>
    <input id="author" placeholder="Author"/><br/>
    <button onclick="submitEntry()">Submit</button>
    <p id="message"></p>
  </div>

  <h2>üìö Submitted Books</h2>
  <table id="submissionTable" border="1" style="margin: auto; margin-top: 20px;">
    <thead>
      <tr>
        <th>Name</th>
        <th>Title</th>
        <th>Author</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script defer>
  window.addEventListener('DOMContentLoaded', () => {
    const firebaseConfig = {
      apiKey: "AIzaSyDlQQOiioFMEsvvJfduLXlDqMN1T5s8cWo",
      authDomain: "bookies-availability.firebaseapp.com",
      databaseURL: "https://bookies-availability-default-rtdb.firebaseio.com",
      projectId: "bookies-availability",
      storageBucket: "bookies-availability.appspot.com",
      messagingSenderId: "429713911832",
      appId: "1:429713911832:web:0da21ca51099bfd8e7536d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const hours = [17, 18, 19, 20, 21, 22];
    
    //const countdownEl = document.getElementById('countdownTimer');
    const countdownTimer = document.getElementById('countdownTimer');
    let timerInterval = null;
    
    function startCountdown() {
    if (!cutoffDate) return;
    function updateCountdown() {
      const now = new Date();
      const diff = cutoffDate - now;
      if (diff <= 0) {
        countdownTimer.textContent = "‚õî Submissions are now closed.";
        clearInterval(timerInterval);
        location.reload();
        return;
      }
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hrs = Math.floor((diff / (1000 * 60 * 60)) % 24);
      const mins = Math.floor((diff / (1000 * 60)) % 60);
      const secs = Math.floor((diff / 1000) % 60);
      countdownTimer.textContent = `‚è≥ Time left to submit: ${days}d ${hrs}h ${mins}m ${secs}s`;
    }
    timerInterval = setInterval(updateCountdown, 1000);
    updateCountdown();
  }
    /*function startCountdown(deadlineISO) {
      const deadline = new Date(deadlineISO);
      function updateCountdown() {
        const now = new Date();
        const diff = deadline - now;
        if (diff <= 0) {
          countdownEl.textContent = "‚õî Submission deadline has passed.";
          document.getElementById('formSection').style.display = 'none';
          return;
        }
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
        const m = Math.floor((diff / (1000 * 60)) % 60);
        const s = Math.floor((diff / 1000) % 60);
        countdownEl.textContent = `‚è≥ Time left to submit: ${d}d ${h}h ${m}m ${s}s`;
      }
      updateCountdown();
      setInterval(updateCountdown, 1000);
    }*/
db.ref('settings/bookSubmissionDeadline').once('value').then(snapshot => {
  const deadlineISO = snapshot.val();
  
    cutoffDate = new Date(deadlineISO);
  startCountdown();
  //const deadline = new Date(deadlineISO);
  const now = new Date();
  
  if (now > cutoffDate) {
    // Deadline passed ‚Äî check if book already selected
    document.getElementById('formSection').style.display = 'none';
    db.ref('selectedBook').once('value').then(bookSnap => {
      const selected = bookSnap.val();

      if (selected) {
        showSelectedBook(selected);
      } else {
        db.ref('submissions').once('value').then(subSnap => {
          const submissions = subSnap.val();
          const names = Object.keys(submissions);
          if (names.length === 0) return;

          const randomName = names[Math.floor(Math.random() * names.length)];
          const selected = {
            ...submissions[randomName],
            submitter: randomName,
            date: now.toLocaleDateString()
          };

          db.ref('selectedBook').set(selected);
          db.ref('history').set(selected);
          showSelectedBook(selected);
        });
      }
    });
  }else {
    startCountdown();  // ‚úÖ show countdown if before deadline
  }
});
    function loadSubmissions() {
      db.ref('submissions').once('value').then(snapshot => {
        const data = snapshot.val() || {};
        const tbody = document.querySelector('#submissionTable tbody');
        tbody.innerHTML = '';
        Object.entries(data).forEach(([name, { title, author }]) => {
          const row = document.createElement('tr');
          row.innerHTML = `<td>${name}</td><td>${title}</td><td>${author}</td>`;
          tbody.appendChild(row);
        });
      });
    }

window.submitEntry = () => {
    const now = new Date();
  if (now > cutoffDate) {
    document.getElementById('message').textContent = '‚õî Submissions are closed.';
    return;
  }
  
  let name = document.getElementById('name').value.trim().toLowerCase();
  const title = document.getElementById('title').value.trim();
  const author = document.getElementById('author').value.trim();
  const msg = document.getElementById('message');
  const submitBtn = document.querySelector('button[onclick="submitEntry()"]');

  if (!name || !title || !author) {
    msg.textContent = '‚ö†Ô∏è Fill all fields.';
    return;
  }

  if (name === 'katie') {
    const which = prompt('Which Katie? (daniels or rohrer)');
    if (!['daniels', 'rohrer'].includes(which)) return;
    name = `katie ${which}`;
  }

  db.ref('submissions/' + name).once('value').then(snapshot => {
    const existing = snapshot.val();
    if (existing) {
      const confirmOverwrite = confirm('You already submitted a book. Overwrite?');
      if (!confirmOverwrite) return;
    }

    const entry = { title, author };
    db.ref('submissions/' + name).set(entry).then(() => {
      msg.textContent = existing ? 'üîÅ Re-submitted!' : '‚úÖ Submitted!';
      submitBtn.textContent = 'Re-submit';
      document.getElementById('title').value = '';
      document.getElementById('author').value = '';
      loadSubmissions();
    });
  });
};
   loadSubmissions();
function showSelectedBook(book) {
  const msg = document.createElement('p');
  msg.style.fontSize = '1.2em';
  msg.style.fontWeight = 'bold';
  msg.style.color = '#2c5f2d';
  msg.textContent = `üéâ Next book is "${book.title}" by ${book.author} (submitted by ${book.submitter})!`;
  document.body.appendChild(msg);
}

function showRandomWinner(book) {
  db.ref('submissions').once('value').then(snapshot => {
    const data = snapshot.val();
    if (data && Object.keys(data).length > 0) {
      const names = Object.keys(data);
      const randomName = names[Math.floor(Math.random() * names.length)];
      const book = data[randomName];

      // Display winner
      const winnerMsg = document.createElement('p');
      winnerMsg.style.fontSize = '1.2em';
      winnerMsg.style.fontWeight = 'bold';
      winnerMsg.style.color = '#2c5f2d';
      winnerMsg.textContent = `üéâ Next book is "${book.title}" by ${book.author}!`;
      document.body.appendChild(winnerMsg);

      // Save as a single object instead of pushing multiple
db.ref('history').set({
  title: selectedBook.title,
  author: selectedBook.author,
  submitter: selectedName,
  date: new Date().toLocaleDateString()
});

    }
  });
}


  });

</script>
</body>
</html>
